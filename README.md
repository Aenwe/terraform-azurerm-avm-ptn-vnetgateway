# Microsoft Verified Terraform Module

The Verified Terraform module is a template repository to help developers create their own Terraform Module.

As we've used Microsoft 1ES Runners Pool as our acceptance test runner, **only Microsoft members could use this template for now**.

Enjoy it by following steps:

1. Use [this template](https://github.com/Azure/terraform-verified-module) to create your repository.
2. Read [Onboard 1ES hosted Github Runners Pool through Azure Portal](https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-github-runners/createpoolportal), install [1ES Resource Management](https://github.com/apps/1es-resource-management) on your repo.
3. Add a Github [Environment](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment) named **acctests** in your repo, setup [**Required Reviewers**](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#required-reviewers).
4. Update [`acc-test.yaml`](.github/workflows/acc-test.yaml), modify `runs-on: [self-hosted, 1ES.Pool=<YOUR_REPO_NAME>]` with your 1es runners' pool name (basically it's your repo's name).
5. Write Terraform code in a new branch.
6. Run `docker run --rm -v ${pwd}:/src -w /src mcr.microsoft.com/azterraform:latest make pre-commit` to format the code.
7. Run `docker run --rm -v $(pwd):/src -w /src mcr.microsoft.com/azterraform:latest make pr-check` to run the check in local.
8. Create a pull request for the main branch.
    * CI pr-check will be executed automatically.
    * Once pr-check was passed, with manually approval, the e2e test and version upgrade test would be executed.
9. Merge pull request.
10. Enjoy it!

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name                                                                      | Version       |
|---------------------------------------------------------------------------|---------------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3        |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm)       | >= 3.1, < 4.0 |

## Providers

| Name                                                          | Version       |
|---------------------------------------------------------------|---------------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >= 3.1, < 4.0 |

## Modules

No modules.

## Resources

| Name                                                                                                                                                                 | Type     |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| [azurerm_express_route_circuit_peering.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/express_route_circuit_peering)           | resource |
| [azurerm_local_network_gateway.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/local_network_gateway)                           | resource |
| [azurerm_public_ip.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip)                                                   | resource |
| [azurerm_route_table.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/route_table)                                               | resource |
| [azurerm_subnet.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet)                                                         | resource |
| [azurerm_subnet_route_table_association.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/subnet_route_table_association)         | resource |
| [azurerm_virtual_network_gateway.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network_gateway)                       | resource |
| [azurerm_virtual_network_gateway_connection.vgw](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/virtual_network_gateway_connection) | resource |

## Inputs

| Name                                                                                                                                                                    | Description                                                                                                                    | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Default        | Required |
|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------|:--------:|
| <a name="input_default_tags"></a> [default\_tags](#input\_default\_tags)                                                                                                | Tags to apply to all resources.                                                                                                | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `{}`           |    no    |
| <a name="input_edge_zone"></a> [edge\_zone](#input\_edge\_zone)                                                                                                         | The availability zone of the virtual network gateway. Only supported for AZ SKUs.                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`         |    no    |
| <a name="input_express_route_circuits"></a> [express\_route\_circuits](#input\_express\_route\_circuits)                                                                | Express Route circuits configuration.                                                                                          | <pre>map(object({<br>    connection_config = optional(object({<br>      express_route_circuit_id     = string<br>      authorization_key            = optional(string, null)<br>      express_route_gateway_bypass = optional(bool, null)<br>      name                         = optional(string, null)<br>      routing_weight               = optional(number, null)<br>      shared_key                   = optional(string, null)<br>      tags                         = optional(map(string), null)<br>    }), null)<br>    peering_config = optional(object({<br>      express_route_circuit_name    = string<br>      peering_type                  = string<br>      vlan_id                       = number<br>      ipv4_enabled                  = optional(bool, null)<br>      peer_asn                      = optional(number, null)<br>      primary_peer_address_prefix   = optional(number, null)<br>      secondary_peer_address_prefix = optional(string, null)<br>      shared_key                    = optional(string, null)<br>      route_filter_id               = optional(string, null)<br>      microsoft_peering_config = optional(object({<br>        advertised_communities     = optional(list(string), null)<br>        advertised_public_prefixes = list(string)<br>        customer_asn               = optional(number, null)<br>        routing_registry_name      = optional(string, null)<br>      }), null)<br>    }), null)<br>  }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `null`         |    no    |
| <a name="input_ip_configurations"></a> [ip\_configurations](#input\_ip\_configurations)                                                                                 | IP configurations for the virtual network gateway.                                                                             | <pre>map(object({<br>    ip_configuration_name        = optional(string, null)<br>    apipa_addresses              = optional(list(string), null)<br>    private_ip_allocation_method = optional(string, "Dynamic")<br>    public_ip = optional(object({<br>      name              = optional(string, null)<br>      allocation_method = optional(string, "Dynamic")<br>      sku               = optional(string, "Basic")<br>      tags              = optional(map(string), {})<br>    }), {})<br>  }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `null`         |    no    |
| <a name="input_local_network_gateways"></a> [local\_network\_gateways](#input\_local\_network\_gateways)                                                                | Local network gateways configuration.                                                                                          | <pre>map(object({<br>    name            = optional(string, null)<br>    address_space   = optional(list(string), null)<br>    gateway_fqdn    = optional(string, null)<br>    gateway_address = optional(string, null)<br>    tags            = optional(map(string), null)<br>    bgp_settings = optional(object({<br>      asn                 = number<br>      bgp_peering_address = string<br>      peer_weight         = optional(number, null)<br>    }), null)<br>    connection_config = optional(object({<br>      name                               = optional(string, null)<br>      type                               = string<br>      connection_mode                    = optional(string, null)<br>      connection_protocol                = optional(string, null)<br>      dpd_timeout_seconds                = optional(number, null)<br>      egress_nat_rule_ids                = optional(list(string), null)<br>      enable_bgp                         = optional(bool, null)<br>      ingress_nat_rule_ids               = optional(list(string), null)<br>      local_azure_ip_address_enabled     = optional(bool, null)<br>      peer_virtual_network_gateway_id    = optional(string, null)<br>      routing_weight                     = optional(number, null)<br>      shared_key                         = optional(string, null)<br>      tags                               = optional(map(string), null)<br>      use_policy_based_traffic_selectors = optional(bool, null)<br>      custom_bgp_addresses = optional(object({<br>        primary   = string<br>        secondary = string<br>      }), null)<br>      ipsec_policy = optional(object({<br>        dh_group         = string<br>        ike_encryption   = string<br>        ike_integrity    = string<br>        ipsec_encryption = string<br>        ipsec_integrity  = string<br>        pfs_group        = string<br>        sa_datasize      = optional(number, null)<br>        sa_lifetime      = optional(number, null)<br>      }), null)<br>      traffic_selector_policy = optional(list(<br>        object({<br>          local_address_prefixes  = list(string)<br>          remote_address_prefixes = list(string)<br>        })<br>      ), null)<br>    }), null)<br>  }))</pre> | `null`         |    no    |
| <a name="input_location"></a> [location](#input\_location)                                                                                                              | The Azure region where the resources will be deployed.                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_name"></a> [name](#input\_name)                                                                                                                          | The name of the virtual network gateway.                                                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name)                                                                         | The name of the resource group.                                                                                                | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_route_table_bgp_route_propagation_enabled"></a> [route\_table\_bgp\_route\_propagation\_enabled](#input\_route\_table\_bgp\_route\_propagation\_enabled) | Whether or not to enable BGP route propagation on the route table.                                                             | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `true`         |    no    |
| <a name="input_route_table_creation_enabled"></a> [route\_table\_creation\_enabled](#input\_route\_table\_creation\_enabled)                                            | Whether or not to create a route table associated with the Virtual Network Gateway Subnet.                                     | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `false`        |    no    |
| <a name="input_route_table_name"></a> [route\_table\_name](#input\_route\_table\_name)                                                                                  | Name of the route table associated with Virtual Network Gateway Subnet.                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`         |    no    |
| <a name="input_route_table_tags"></a> [route\_table\_tags](#input\_route\_table\_tags)                                                                                  | Tags for the route table.                                                                                                      | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `{}`           |    no    |
| <a name="input_sku"></a> [sku](#input\_sku)                                                                                                                             | The SKU (size) of the virtual network gateway.                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_subnet_address_prefix"></a> [subnet\_address\_prefix](#input\_subnet\_address\_prefix)                                                                   | The address prefix for the gateway subnet.                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_tags"></a> [tags](#input\_tags)                                                                                                                          | Tags to apply to the virtual network gateway.                                                                                  | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `{}`           |    no    |
| <a name="input_tracing_tags_enabled"></a> [tracing\_tags\_enabled](#input\_tracing\_tags\_enabled)                                                                      | Whether enable tracing tags that generated by BridgeCrew Yor.                                                                  | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `false`        |    no    |
| <a name="input_tracing_tags_prefix"></a> [tracing\_tags\_prefix](#input\_tracing\_tags\_prefix)                                                                         | Default prefix for generated tracing tags                                                                                      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `"avm_"`       |    no    |
| <a name="input_type"></a> [type](#input\_type)                                                                                                                          | The type of the virtual network gateway, ExpressRoute or VPN.                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_virtual_network_name"></a> [virtual\_network\_name](#input\_virtual\_network\_name)                                                                      | The name of the virtual network.                                                                                               | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | n/a            |   yes    |
| <a name="input_vpn_active_active_enabled"></a> [vpn\_active\_active\_enabled](#input\_vpn\_active\_active\_enabled)                                                     | Enable active-active mode for the virtual network gateway.                                                                     | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `false`        |    no    |
| <a name="input_vpn_bgp_enabled"></a> [vpn\_bgp\_enabled](#input\_vpn\_bgp\_enabled)                                                                                     | Enable BGP for the virtual network gateway.                                                                                    | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `false`        |    no    |
| <a name="input_vpn_bgp_settings"></a> [vpn\_bgp\_settings](#input\_vpn\_bgp\_settings)                                                                                  | BGP settings for the virtual network gateway.                                                                                  | <pre>object({<br>    asn         = optional(number, null)<br>    peer_weight = optional(number, null)<br>  })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `null`         |    no    |
| <a name="input_vpn_generation"></a> [vpn\_generation](#input\_vpn\_generation)                                                                                          | value for the Generation for the Gateway, Valid values are 'Generation1', 'Generation2'. Options differ depending on SKU.      | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `null`         |    no    |
| <a name="input_vpn_private_ip_address_enabled"></a> [vpn\_private\_ip\_address\_enabled](#input\_vpn\_private\_ip\_address\_enabled)                                    | Enable private IP address for the virtual network gateway for Virtual Network Gateway Connections. Only supported for AZ SKUs. | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `null`         |    no    |
| <a name="input_vpn_type"></a> [vpn\_type](#input\_vpn\_type)                                                                                                            | The VPN type of the virtual network gateway.                                                                                   | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `"RouteBased"` |    no    |

## Outputs

| Name                                                                                                                                 | Description                                                                              |
|--------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------|
| <a name="output_local_network_gateway_ids"></a> [local\_network\_gateway\_ids](#output\_local\_network\_gateway\_ids)                | value for local\_network\_gateway\_ids. The IDs of the local network gateways.           |
| <a name="output_public_ip_address_ids"></a> [public\_ip\_address\_ids](#output\_public\_ip\_address\_ids)                            | value for public\_ip\_address\_ids. The IDs of the public IP addresses.                  |
| <a name="output_route_table_name"></a> [route\_table\_name](#output\_route\_table\_name)                                             | value for the name of the route table.                                                   |
| <a name="output_virtual_network_connection_ids"></a> [virtual\_network\_connection\_ids](#output\_virtual\_network\_connection\_ids) | value for virtual\_network\_connection\_ids. The IDs of the virtual network connections. |
| <a name="output_virtual_network_gateway_id"></a> [virtual\_network\_gateway\_id](#output\_virtual\_network\_gateway\_id)             | value for virtual\_network\_gateway\_id. The ID of the virtual network gateway.          |
<!-- END_TF_DOCS -->
